---
phase: 03-audio-core-polish
plan: 07
type: execute
---

<objective>
Final verification, coverage check, and commit for Phase 03.

Purpose: Ensure all Phase 03 work is complete, tested, and properly committed.
Output: Phase 03 complete, ready for PR or next phase.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-audio-core-polish/03-06-SUMMARY.md

**Prior plans completed:**
- 03-01: LUFS infrastructure (ebur128, AudioData.lufs)
- 03-02: LUFS calculation in decode
- 03-03: AppSettings extension
- 03-04: Volume curve and LUFS gain functions
- 03-05: Playback integration
- 03-06: Frontend UI

**Constraints:**
- Coverage must not decrease
- All tests must pass (Rust + Frontend)
- Single commit for entire Phase 03 work
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run all tests and coverage checks</name>
  <files>N/A</files>
  <action>
    1. Run Rust tests:
       ```bash
       cd src-tauri && cargo test
       ```

    2. Run Rust coverage:
       ```bash
       cd src-tauri && cargo llvm-cov
       ```

    3. Run Frontend tests:
       ```bash
       yarn test:run
       ```

    4. Run Frontend coverage:
       ```bash
       yarn test:coverage
       ```

    5. Run linting and type checks:
       ```bash
       yarn lint && yarn typecheck
       ```

    6. Document any failing tests and fix them before proceeding
  </action>
  <verify>All tests pass, coverage >= baseline</verify>
  <done>All tests passing, coverage maintained</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete LUFS normalization feature with UI</what-built>
  <how-to-verify>
    1. Run: `yarn tauri dev`
    2. Wait for app to start

    **Test Settings UI:**
    3. Open Settings (gear icon)
    4. Go to Playback settings
    5. Verify "Enable loudness normalization" toggle exists
    6. Toggle it ON - slider should appear
    7. Slider should show current value (e.g., "-14 LUFS")
    8. Slider should have range labels ("Quieter" / "Louder")

    **Test Normalization Effect:**
    9. Add a quiet sound and a loud sound to the soundboard
    10. With normalization OFF: Play both - they should sound at different volumes
    11. With normalization ON: Play both - they should sound more similar in volume
    12. Adjust target LUFS slider - sounds should get louder/quieter

    **Test Persistence:**
    13. Enable normalization, set target to -16 LUFS
    14. Close and reopen the app
    15. Settings should be preserved

    **Test Edge Cases:**
    16. Very short sound (<1 sec) - should still play (may not normalize)
    17. Disable normalization - sounds should return to original volume
  </how-to-verify>
  <resume-signal>Type "approved" if everything works, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create final commit for Phase 03</name>
  <files>N/A (git operations)</files>
  <action>
    After user approval, create comprehensive commit:

    ```bash
    git add -A && git commit -m "$(cat <<'EOF'
feat(audio): implement LUFS loudness normalization

Problem:
- Different sounds play at inconsistent loudness levels
- Users had to manually adjust volume for each sound
- Volume slider didn't feel natural (linear scaling)

Solution:
- Integrate ebur128 crate for EBU R 128 loudness measurement
- Calculate integrated LUFS during audio decode
- Apply normalization gain during playback (configurable)
- Add settings for enable/disable and target LUFS

Backend (Rust):
- Add ebur128 = "0.1" dependency
- Extend AudioData with lufs: Option<f32> field
- Add calculate_lufs() in decode.rs
- Add calculate_lufs_gain() and db_to_linear() in playback.rs
- Extend AppSettings with enable_lufs_normalization and target_lufs
- Apply LUFS gain in playback stream
- Clamp gain to +/- 12 dB for safety
- Add comprehensive unit tests

Frontend (React):
- Add normalization toggle in PlaybackSettings
- Add target LUFS slider (-23 to -7)
- Show slider only when normalization enabled
- Update SettingsContext with defaults
EOF
)"
    ```
  </action>
  <verify>`git log -1 --oneline` shows the commit</verify>
  <done>Phase 03 work committed to feature branch</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cargo test --manifest-path src-tauri/Cargo.toml` all pass
- [ ] `cargo llvm-cov` coverage >= baseline
- [ ] `yarn test:run` all pass
- [ ] `yarn test:coverage` coverage >= baseline
- [ ] `yarn typecheck && yarn lint` pass
- [ ] User verified UI and functionality
- [ ] Single commit on feature branch
</verification>

<success_criteria>
- All tests passing (Rust + Frontend)
- Coverage maintained or improved
- UI works as expected
- Normalization audibly affects playback
- Settings persist across restarts
- Clean commit on feature branch
- Phase 03 complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-audio-core-polish/03-07-SUMMARY.md`

Include:
- Final coverage numbers (Rust + Frontend)
- User verification feedback
- Commit hash
- Phase 03 status: COMPLETE
- Ready for: PR to develop, or next phase

Also update `.planning/STATE.md`:
- Phase: 3 complete
- Last activity: [date]
</output>
