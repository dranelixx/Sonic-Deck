---
phase: 03-audio-core-polish
plan: 06
type: execute
---

<objective>
Add LUFS normalization UI controls to Settings.

Purpose: Allow users to enable/disable loudness normalization and adjust target level.
Output: Settings UI with normalization toggle and target LUFS slider.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-audio-core-polish/03-05-SUMMARY.md
@.planning/phases/03-audio-core-polish/03-CONTEXT.md

**Prior decisions affecting this plan:**
- Global toggle (not per-sound)
- User prefers preset labels over raw LUFS numbers
- Target range: -23 to -7 LUFS
- All UI text in English

**Relevant source files:**
@src/components/settings/PlaybackSettings.tsx
@src/components/settings/Settings.tsx
@src/contexts/SettingsContext.tsx
@src/types.ts

**Constraints:**
- Follow existing Settings component patterns
- Toggle and slider must save to backend immediately
- Show slider only when normalization enabled
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add normalization toggle to PlaybackSettings</name>
  <files>src/components/settings/PlaybackSettings.tsx</files>
  <action>
    1. Find PlaybackSettings component and add a new section:
       ```tsx
       {/* Loudness Normalization */}
       <div className="space-y-4">
         <h3 className="text-sm font-medium text-zinc-400">Loudness Normalization</h3>

         {/* Enable toggle */}
         <div className="flex items-center justify-between">
           <div>
             <label className="text-sm text-zinc-300">Enable loudness normalization</label>
             <p className="text-xs text-zinc-500">
               Automatically adjust volume so all sounds play at similar loudness
             </p>
           </div>
           <button
             onClick={handleToggleNormalization}
             className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
               settings.enable_lufs_normalization ? 'bg-green-600' : 'bg-zinc-600'
             }`}
             aria-label="Toggle loudness normalization"
           >
             <span
               className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                 settings.enable_lufs_normalization ? 'translate-x-6' : 'translate-x-1'
               }`}
             />
           </button>
         </div>
       </div>
       ```

    2. Add handler function:
       ```tsx
       const handleToggleNormalization = async () => {
         const newSettings = {
           ...settings,
           enable_lufs_normalization: !settings.enable_lufs_normalization
         };
         await invoke('update_settings', { settings: newSettings });
         updateSettings(newSettings);
       };
       ```

    3. Ensure settings and updateSettings come from SettingsContext
  </action>
  <verify>`yarn typecheck` passes</verify>
  <done>Normalization toggle added to PlaybackSettings</done>
</task>

<task type="auto">
  <name>Task 2: Add target loudness slider</name>
  <files>src/components/settings/PlaybackSettings.tsx</files>
  <action>
    1. Add slider that shows only when normalization is enabled:
       ```tsx
       {settings.enable_lufs_normalization && (
         <div className="space-y-2">
           <div className="flex items-center justify-between">
             <label className="text-sm text-zinc-300">Target loudness</label>
             <span className="text-sm text-zinc-400">{settings.target_lufs} LUFS</span>
           </div>
           <input
             type="range"
             min="-23"
             max="-7"
             step="1"
             value={settings.target_lufs}
             onChange={handleTargetLufsChange}
             className="w-full h-2 bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-green-500"
             aria-label="Target loudness level"
           />
           <div className="flex justify-between text-xs text-zinc-500">
             <span>Quieter (-23)</span>
             <span>Louder (-7)</span>
           </div>
         </div>
       )}
       ```

    2. Add handler with debouncing (optional, can be immediate for now):
       ```tsx
       const handleTargetLufsChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
         const value = parseFloat(e.target.value);
         const newSettings = { ...settings, target_lufs: value };
         await invoke('update_settings', { settings: newSettings });
         updateSettings(newSettings);
       };
       ```

    3. Consider adding preset buttons (optional enhancement):
       - "Quiet" (-18 LUFS)
       - "Normal" (-14 LUFS)
       - "Loud" (-11 LUFS)
  </action>
  <verify>`yarn typecheck` passes</verify>
  <done>Target loudness slider added with labels</done>
</task>

<task type="auto">
  <name>Task 3: Update SettingsContext with default values</name>
  <files>src/contexts/SettingsContext.tsx</files>
  <action>
    1. Find the default settings initialization in SettingsContext

    2. Add default values for new fields:
       ```tsx
       const defaultSettings: AppSettings = {
         // ... existing defaults ...
         enable_lufs_normalization: false,
         target_lufs: -14,
       };
       ```

    3. Ensure the context properly loads settings from backend on mount

    4. Verify that updateSettings properly handles new fields

    5. Run `yarn lint` to check for any issues
  </action>
  <verify>`yarn typecheck && yarn lint` passes</verify>
  <done>SettingsContext updated with LUFS normalization defaults</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `yarn typecheck` passes
- [ ] `yarn lint` passes
- [ ] Toggle renders and switches between on/off states
- [ ] Slider only visible when toggle is on
- [ ] Slider shows current value and range labels
- [ ] Changes persist to backend (invoke called)
</verification>

<success_criteria>
- Normalization toggle in PlaybackSettings
- Target LUFS slider with range -23 to -7
- Slider hidden when normalization disabled
- All UI text in English
- Settings sync with backend on change
- No TypeScript or linting errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-audio-core-polish/03-06-SUMMARY.md`

Include:
- UI elements added
- Interaction patterns implemented
- Any styling decisions made
- Ready for Plan 07 (E2E verification)
</output>
