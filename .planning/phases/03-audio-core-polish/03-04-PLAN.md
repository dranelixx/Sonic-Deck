---
phase: 03-audio-core-polish
plan: 04
type: execute
---

<objective>
Implement volume curve improvement and LUFS gain calculation.

Purpose: Add core volume processing functions for perceptual volume control and loudness compensation.
Output: calculate_lufs_gain(), db_to_linear(), improved calculate_scaled_volume() with unit tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-audio-core-polish/03-03-SUMMARY.md
@.planning/phases/03-audio-core-polish/03-RESEARCH.md

**Prior decisions affecting this plan:**
- Use x^2 curve (simpler than x^4, still perceptual improvement over sqrt)
- Clamp LUFS gain to +/- 12 dB to prevent clipping/distortion
- Preserve base attenuation (0.2) for safety

**Relevant source files:**
@src-tauri/src/audio/playback.rs

**Constraints:**
- Functions must be #[inline] for performance
- Existing calculate_scaled_volume signature might need to be preserved for backward compat
- All volume calculations must remain deterministic
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add db_to_linear() helper function</name>
  <files>src-tauri/src/audio/playback.rs</files>
  <action>
    Add helper function for dB to linear gain conversion:

    ```rust
    /// Convert decibels to linear gain multiplier.
    ///
    /// Examples:
    /// - 0 dB → 1.0 (no change)
    /// - +6 dB → 2.0 (double amplitude)
    /// - -6 dB → 0.5 (half amplitude)
    /// - +20 dB → 10.0
    #[inline]
    pub(crate) fn db_to_linear(db: f32) -> f32 {
        10.0_f32.powf(db / 20.0)
    }
    ```
  </action>
  <verify>`cargo check --manifest-path src-tauri/Cargo.toml` passes</verify>
  <done>db_to_linear() function added</done>
</task>

<task type="auto">
  <name>Task 2: Add calculate_lufs_gain() function</name>
  <files>src-tauri/src/audio/playback.rs</files>
  <action>
    Add LUFS gain calculation function:

    ```rust
    /// Calculate gain adjustment for LUFS normalization.
    ///
    /// Returns linear gain multiplier to reach target loudness.
    /// Gain is clamped to +/- 12 dB to prevent extreme adjustments.
    ///
    /// # Arguments
    /// * `sound_lufs` - Measured LUFS of the sound (None = no adjustment)
    /// * `target_lufs` - Target loudness in LUFS (e.g., -14.0)
    /// * `enabled` - Whether normalization is enabled
    ///
    /// # Returns
    /// Linear gain multiplier (1.0 = no change)
    #[inline]
    pub(crate) fn calculate_lufs_gain(
        sound_lufs: Option<f32>,
        target_lufs: f32,
        enabled: bool,
    ) -> f32 {
        if !enabled {
            return 1.0;
        }

        match sound_lufs {
            Some(lufs) => {
                // Difference in LUFS = difference in dB
                let diff_db = target_lufs - lufs;

                // Clamp to reasonable range to prevent extreme gain
                // +12 dB ≈ 4x amplification, -12 dB ≈ 0.25x
                let clamped_db = diff_db.clamp(-12.0, 12.0);

                db_to_linear(clamped_db)
            }
            None => 1.0, // No LUFS data available, no adjustment
        }
    }
    ```
  </action>
  <verify>`cargo check --manifest-path src-tauri/Cargo.toml` passes</verify>
  <done>calculate_lufs_gain() function added</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for volume/gain functions</name>
  <files>src-tauri/src/audio/playback.rs</files>
  <action>
    Add tests to the `#[cfg(test)]` module:

    ```rust
    // ========== Volume Engine V2 tests ==========

    #[test]
    fn test_db_to_linear_zero() {
        let gain = db_to_linear(0.0);
        assert!((gain - 1.0).abs() < 0.0001, "0 dB should be 1.0, got {}", gain);
    }

    #[test]
    fn test_db_to_linear_positive() {
        let gain = db_to_linear(6.0);
        assert!((gain - 2.0).abs() < 0.01, "+6 dB should be ~2.0, got {}", gain);

        let gain = db_to_linear(20.0);
        assert!((gain - 10.0).abs() < 0.01, "+20 dB should be ~10.0, got {}", gain);
    }

    #[test]
    fn test_db_to_linear_negative() {
        let gain = db_to_linear(-6.0);
        assert!((gain - 0.5).abs() < 0.01, "-6 dB should be ~0.5, got {}", gain);

        let gain = db_to_linear(-20.0);
        assert!((gain - 0.1).abs() < 0.01, "-20 dB should be ~0.1, got {}", gain);
    }

    #[test]
    fn test_lufs_gain_disabled() {
        let gain = calculate_lufs_gain(Some(-20.0), -14.0, false);
        assert!((gain - 1.0).abs() < 0.0001, "Disabled should return 1.0, got {}", gain);
    }

    #[test]
    fn test_lufs_gain_no_data() {
        let gain = calculate_lufs_gain(None, -14.0, true);
        assert!((gain - 1.0).abs() < 0.0001, "No LUFS data should return 1.0, got {}", gain);
    }

    #[test]
    fn test_lufs_gain_quiet_sound() {
        // Sound at -20 LUFS, target -14 LUFS -> boost by 6 dB -> gain ~2.0
        let gain = calculate_lufs_gain(Some(-20.0), -14.0, true);
        let expected = db_to_linear(6.0);
        assert!((gain - expected).abs() < 0.01, "Expected {}, got {}", expected, gain);
    }

    #[test]
    fn test_lufs_gain_loud_sound() {
        // Sound at -10 LUFS, target -14 LUFS -> reduce by 4 dB -> gain ~0.63
        let gain = calculate_lufs_gain(Some(-10.0), -14.0, true);
        let expected = db_to_linear(-4.0);
        assert!((gain - expected).abs() < 0.01, "Expected {}, got {}", expected, gain);
    }

    #[test]
    fn test_lufs_gain_clamped_boost() {
        // Sound at -40 LUFS, target -14 LUFS -> would be +26 dB, clamped to +12 dB
        let gain = calculate_lufs_gain(Some(-40.0), -14.0, true);
        let expected = db_to_linear(12.0); // ~3.98
        assert!((gain - expected).abs() < 0.01, "Should clamp to +12 dB ({:.2}), got {:.2}", expected, gain);
    }

    #[test]
    fn test_lufs_gain_clamped_cut() {
        // Sound at 0 LUFS, target -14 LUFS -> would be -14 dB, clamped to -12 dB
        let gain = calculate_lufs_gain(Some(0.0), -14.0, true);
        let expected = db_to_linear(-12.0); // ~0.25
        assert!((gain - expected).abs() < 0.01, "Should clamp to -12 dB ({:.2}), got {:.2}", expected, gain);
    }

    #[test]
    fn test_lufs_gain_at_target() {
        // Sound already at target -> no adjustment
        let gain = calculate_lufs_gain(Some(-14.0), -14.0, true);
        assert!((gain - 1.0).abs() < 0.0001, "At target should return 1.0, got {}", gain);
    }
    ```
  </action>
  <verify>`cargo test --manifest-path src-tauri/Cargo.toml playback` passes all tests</verify>
  <done>Volume/gain unit tests added and passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo check --manifest-path src-tauri/Cargo.toml` passes
- [ ] `cargo test --manifest-path src-tauri/Cargo.toml playback` passes
- [ ] db_to_linear() converts correctly (0dB=1.0, +6dB≈2.0, -6dB≈0.5)
- [ ] calculate_lufs_gain() returns 1.0 when disabled or no LUFS data
- [ ] Gain is clamped to +/- 12 dB range
</verification>

<success_criteria>
- db_to_linear() implemented and tested
- calculate_lufs_gain() implemented with clamping
- All edge cases covered by tests
- Functions are #[inline] for performance
- No changes to existing playback behavior yet (integration in Plan 05)
</success_criteria>

<output>
After completion, create `.planning/phases/03-audio-core-polish/03-04-SUMMARY.md`

Include:
- Functions added
- Test results
- dB/linear conversion accuracy
- Ready for Plan 05 (playback integration)
</output>
