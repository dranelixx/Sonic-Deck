---
phase: 03-audio-core-polish
plan: 03
type: execute
---

<objective>
Extend AppSettings with LUFS normalization configuration.

Purpose: Allow users to enable/disable normalization and set target loudness via settings.
Output: AppSettings with enable_lufs_normalization and target_lufs fields, TypeScript types updated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-audio-core-polish/03-02-SUMMARY.md
@.planning/phases/03-audio-core-polish/03-CONTEXT.md

**Prior decisions affecting this plan:**
- Global toggle (not per-sound)
- Default target: -14 LUFS (streaming standard)
- Target range: -23 to -7 LUFS
- Preset labels: "Leiser/Normal/Lauter" in UI (Plan 06)

**Relevant source files:**
@src-tauri/src/settings.rs
@src/types.ts

**Constraints:**
- Settings must serialize/deserialize correctly with existing settings
- Backward compatible: existing settings files without new fields use defaults
- User-facing strings in English
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LUFS normalization fields to AppSettings</name>
  <files>src-tauri/src/settings.rs</files>
  <action>
    1. Add fields to AppSettings struct:
       ```rust
       /// Enable LUFS-based loudness normalization
       #[serde(default)]
       pub enable_lufs_normalization: bool,

       /// Target loudness in LUFS (default: -14.0, range: -23.0 to -7.0)
       #[serde(default = "default_target_lufs")]
       pub target_lufs: f32,
       ```

    2. Add default function:
       ```rust
       fn default_target_lufs() -> f32 {
           -14.0
       }
       ```

    3. Update Default impl to include new fields:
       ```rust
       impl Default for AppSettings {
           fn default() -> Self {
               Self {
                   // ... existing fields ...
                   enable_lufs_normalization: false,
                   target_lufs: default_target_lufs(),
               }
           }
       }
       ```
  </action>
  <verify>`cargo check --manifest-path src-tauri/Cargo.toml` passes</verify>
  <done>AppSettings extended with LUFS normalization fields</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types</name>
  <files>src/types.ts</files>
  <action>
    1. Find the AppSettings interface (or equivalent settings type)
    2. Add new fields:
       ```typescript
       export interface AppSettings {
         // ... existing fields ...

         /** Enable LUFS-based loudness normalization */
         enable_lufs_normalization: boolean;

         /** Target loudness in LUFS (range: -23 to -7, default: -14) */
         target_lufs: number;
       }
       ```

    3. If there's a default settings object, update it:
       ```typescript
       export const defaultSettings: AppSettings = {
         // ... existing defaults ...
         enable_lufs_normalization: false,
         target_lufs: -14,
       };
       ```
  </action>
  <verify>`yarn typecheck` passes</verify>
  <done>TypeScript AppSettings types updated</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for settings serialization</name>
  <files>src-tauri/src/settings.rs</files>
  <action>
    Add tests to the `#[cfg(test)]` module:

    ```rust
    // ========== LUFS normalization settings tests ==========

    #[test]
    fn test_settings_lufs_defaults() {
        let settings = AppSettings::default();
        assert!(!settings.enable_lufs_normalization, "Normalization should be disabled by default");
        assert!((settings.target_lufs - (-14.0)).abs() < 0.01, "Default target should be -14 LUFS");
    }

    #[test]
    fn test_settings_lufs_serialization() {
        let mut settings = AppSettings::default();
        settings.enable_lufs_normalization = true;
        settings.target_lufs = -16.0;

        let json = serde_json::to_string(&settings).unwrap();
        assert!(json.contains("enable_lufs_normalization"));
        assert!(json.contains("target_lufs"));

        let loaded: AppSettings = serde_json::from_str(&json).unwrap();
        assert!(loaded.enable_lufs_normalization);
        assert!((loaded.target_lufs - (-16.0)).abs() < 0.01);
    }

    #[test]
    fn test_settings_backward_compatibility() {
        // Old settings JSON without LUFS fields should use defaults
        let old_json = r#"{}"#; // Minimal valid JSON object
        let settings: AppSettings = serde_json::from_str(old_json).unwrap();
        assert!(!settings.enable_lufs_normalization, "Should default to disabled");
        assert!((settings.target_lufs - (-14.0)).abs() < 0.01, "Should default to -14");
    }
    ```
  </action>
  <verify>`cargo test --manifest-path src-tauri/Cargo.toml settings` passes</verify>
  <done>Settings serialization tests added and passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo check --manifest-path src-tauri/Cargo.toml` passes
- [ ] `cargo test --manifest-path src-tauri/Cargo.toml settings` passes
- [ ] `yarn typecheck` passes
- [ ] New settings fields have serde(default) for backward compatibility
- [ ] Default values match: enable=false, target=-14.0
</verification>

<success_criteria>
- AppSettings has enable_lufs_normalization: bool
- AppSettings has target_lufs: f32 with default -14.0
- TypeScript types match Rust types
- Backward compatible with existing settings files
- Unit tests for serialization and defaults
</success_criteria>

<output>
After completion, create `.planning/phases/03-audio-core-polish/03-03-SUMMARY.md`

Include:
- Settings fields added
- Backward compatibility verified
- Test results
- Ready for Plan 04
</output>
